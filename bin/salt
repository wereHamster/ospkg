#!/usr/bin/bash

[ $# -ne 1 ] && exit 1

ROOT="$PWD/$(dirname $0)/.."
. "$ROOT/recipes/$1/build"

TMPDIR="$(mktemp -d /tmp/salt.XXXXX)" && cd $TMPDIR

wget "http://pkg.caurea.org/-/$SOURCE"

unpack "$SOURCE" && DESTDIR="$TMPDIR/staging" build

PKGREPO="file://$TMPDIR/repo"
eval "$(pkgsend -s "$PKGREPO" create-repository --Set-property publisher.)"
pkgsend -s "$PKGREPO" open "$1@VERSION"
pkgsend -s "$PKGREPO" generate "$TMPDIR/staging" > "$TMPDIR/manifest"
pkgsend -s "$PKGREPO" close
