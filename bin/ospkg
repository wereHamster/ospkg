#!/usr/bin/bash

[ $# -ne 1 ] && exit 1

ROOT="$PWD/$(dirname $0)/.."
. "$ROOT/recipes/$1/build"

mkdir -p "$ROOT/cache"
if [ ! -f "$ROOT/cache/$SOURCE" ]; then
  wget "http://pkg.caurea.org/-/$SOURCE" -O "$ROOT/cache/$SOURCE"
fi

TMPDIR="$(mktemp -d "/tmp/ospkg.XXXXX")" && cd "$TMPDIR"
unpack "$ROOT/cache/$SOURCE" && DESTDIR="$TMPDIR/staging/usr" build

PKGREPO="file://$TMPDIR/repo"
pkgsend -s "$PKGREPO" create-repository --set-property publisher.prefix=caurea.org

( pkgsend generate "$TMPDIR/staging"; cat "$ROOT/recipes/$1/manifest" 2>/dev/null) | \
  pkgmogrify -O "$TMPDIR/manifest"
pkgsend -s "$PKGREPO" publish -d "$TMPDIR/staging" "$1@$VERSION" "$TMPDIR/manifest"

#rm -rf "$TMPDIR"
